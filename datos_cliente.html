<!DOCTYPE html>
<html class="light" lang="es">
<head>
    <meta charset="utf-8"/>
    <title>Confirmar Datos</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = { theme: { extend: { colors: { "primary": "#13ec5b" }, fontFamily: { "display": ["Manrope", "sans-serif"] } } } }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&display=swap" rel="stylesheet"/>
</head>
<body class="bg-[#f6f8f6] font-display min-h-screen flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-md p-8 rounded-2xl shadow-xl border border-gray-100">
        <h1 class="text-2xl font-bold mb-2 text-gray-900">Finalizar Reserva</h1>
        <p class="text-gray-500 mb-6 text-sm">Completa tus datos para confirmar.</p>
        
        <form id="booking-form" class="flex flex-col gap-4">
            
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-500 ml-1">Nombre</label>
                    <input id="name" class="w-full h-12 px-4 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-primary" placeholder="Ej. Tu Nombre" required/>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 ml-1">Tel√©fono</label>
                    <input id="phone" class="w-full h-12 px-4 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-primary" placeholder="Ej. 11 1234 5678" required/>
                </div>
            </div>
            
            <div class="flex flex-col gap-2 bg-gray-50 p-4 rounded-xl border border-gray-100 mt-2">
                <div class="flex items-center gap-3">
                    <div class="bg-primary/20 text-green-700 p-2 rounded-lg font-bold text-lg">üìÖ</div>
                    <div>
                        <p class="text-xs text-gray-400 font-bold uppercase">Fecha y Hora</p>
                        <p class="font-bold text-gray-800 text-sm">
                            <span id="summary-date">...</span> a las <span id="summary-time">--:--</span> hs
                        </p>
                    </div>
                </div>
                <div class="border-t border-gray-200 my-1"></div>
                <div class="flex items-center gap-3">
                    <div class="bg-blue-50 text-blue-600 p-2 rounded-lg font-bold text-lg">‚úÇÔ∏è</div>
                    <div>
                        <p class="text-xs text-gray-400 font-bold uppercase">Servicio</p>
                        <p id="summary-service" class="font-bold text-gray-800 text-sm">...</p>
                    </div>
                </div>
            </div>

            <button type="submit" id="btn-save" class="mt-4 w-full h-14 bg-primary text-black font-extrabold text-lg rounded-xl hover:bg-green-400 transition-all shadow-lg shadow-primary/25">
                Confirmar Turno
            </button>
        </form>
    </div>

    <script>
        const supabase = window.supabase.createClient(
            'https://qeuiiwswouxgfnmjfqyq.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFldWlpd3N3b3V4Z2ZubWpmcXlxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MzI0NDQsImV4cCI6MjA4MTQwODQ0NH0.rjhBWx61XtA-hMxzFLnOaKr9ybQk3Zbj5hnU0jxXhpw'
        );

        const time = localStorage.getItem('turno_seleccionado') || '09:00';
        const date = localStorage.getItem('fecha_seleccionada') || new Date().toISOString().split('T')[0];
        const negocioEmail = localStorage.getItem('negocio_destino'); 
        
        // Recuperar objeto servicio
        let servicio = {name: "Servicio Web", price: ""};
        try {
            const saved = localStorage.getItem('servicio_seleccionado');
            if(saved) servicio = JSON.parse(saved);
        } catch(e) { console.error(e); }

        document.getElementById('summary-time').innerText = time;
        document.getElementById('summary-date').innerText = date.split('-').reverse().join('/');
        document.getElementById('summary-service').innerText = `${servicio.name} ($${servicio.price || '-'})`;

        if (!negocioEmail) alert("‚ö†Ô∏è Error de enlace. Vuelve a escanear el c√≥digo o usar el link.");

        document.getElementById('booking-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-save');
            btn.disabled = true; btn.innerText = "Agendando...";

            const bookingData = {
                client_name: document.getElementById('name').value,
                client_phone: document.getElementById('phone').value,
                business_email: negocioEmail,
                booking_date: date,
                booking_time: time,
                service_name: servicio.name, // Guardamos el nombre real
                status: 'pendiente'
            };

            const { error } = await supabase.from('bookings').insert([bookingData]);

            if (error) {
                alert('Error: ' + error.message);
                btn.disabled = false; btn.innerText = "Confirmar Turno";
            } else {
                window.location.href = 'confirmacion.html';
            }
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html class="light" lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>Reserva tu Turno</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = { theme: { extend: { colors: { "primary": "#13ec5b" }, fontFamily: { "display": ["Manrope", "sans-serif"] } } } }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&display=swap" rel="stylesheet"/>
    <style> body { -webkit-tap-highlight-color: transparent; } </style>
</head>
<body class="bg-[#f6f8f6] font-display min-h-screen flex flex-col items-center p-3 sm:p-4">
    <div class="w-full max-w-lg bg-white rounded-2xl shadow-sm border border-gray-100 p-5">
        <header class="mb-6 border-b border-gray-100 pb-4">
            <h1 class="text-xl font-extrabold text-gray-900">Reservar Turno</h1>
            <p class="text-sm text-gray-500" id="subtitle">Cargando...</p>
        </header>

        <div class="mb-8">
            <label class="text-xs font-bold text-gray-500 uppercase ml-1 mb-2 block">1. Selecciona Servicio</label>
            <div id="services-container" class="grid grid-cols-1 gap-2">
                <p class="text-sm text-gray-400 animate-pulse text-center p-4">Cargando...</p>
            </div>
        </div>

        <div id="calendar-section" class="hidden opacity-50 transition-all duration-500">
            <div class="mb-6">
                <label class="text-xs font-bold text-gray-500 uppercase ml-1">2. Elige el día</label>
                <input type="date" id="date-picker" class="w-full mt-1 border-gray-200 rounded-xl font-bold text-gray-700 h-12 focus:ring-primary focus:border-primary bg-gray-50 text-base" />
            </div>

            <div id="slots-container" class="grid grid-cols-3 sm:grid-cols-4 gap-2 mb-8"></div>
        </div>

        <div class="sticky bottom-0 bg-white pt-4 pb-2 border-t border-gray-100 mt-auto">
            <div class="flex justify-between items-center">
                <div class="flex flex-col">
                    <p class="text-[10px] text-gray-400 uppercase font-bold">Resumen</p>
                    <p id="seleccion-texto" class="text-sm font-bold text-gray-800 truncate max-w-[150px]">Elige...</p>
                </div>
                <button id="btn-continuar" disabled onclick="window.location.href='datos_cliente.html'" class="bg-gray-200 text-gray-400 px-6 py-3 rounded-full font-bold transition-all shadow-sm text-sm disabled:cursor-not-allowed">Continuar</button>
            </div>
        </div>
    </div>

    <script>
        const supabase = window.supabase.createClient(
            'https://qeuiiwswouxgfnmjfqyq.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFldWlpd3N3b3V4Z2ZubWpmcXlxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MzI0NDQsImV4cCI6MjA4MTQwODQ0NH0.rjhBWx61XtA-hMxzFLnOaKr9ybQk3Zbj5hnU0jxXhpw'
        );
        
        const params = new URLSearchParams(window.location.search);
        const negocioEmail = params.get('negocio') || localStorage.getItem('negocio_destino');
        let servicioSeleccionado = null;

        if (negocioEmail) {
            localStorage.setItem('negocio_destino', negocioEmail);
            iniciar();
        } else {
            document.body.innerHTML = "<div class='p-10 text-center text-red-500 font-bold'>Link inválido</div>";
        }

        async function iniciar() {
            const { data: config } = await supabase.from('business_settings').select('*').eq('email', negocioEmail).single();
            if(config?.business_name) document.querySelector('h1').innerText = config.business_name;
            document.getElementById('subtitle').innerText = "Elige tu servicio ideal";

            const container = document.getElementById('services-container');
            container.innerHTML = "";
            (config?.services || [{name: "General", price: ""}]).forEach(srv => {
                const btn = document.createElement('div');
                // RESTAURADO: Diseño con indicador visual
                btn.className = "flex justify-between items-center p-3.5 rounded-xl border border-gray-200 active:bg-green-50 transition-all cursor-pointer bg-white shadow-sm group";
                btn.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="h-4 w-4 rounded-full border border-gray-300 group-hover:border-primary flex items-center justify-center">
                            <div class="h-2 w-2 rounded-full bg-primary opacity-0 group-hover:opacity-100 transition-opacity check-indicator"></div>
                        </div>
                        <span class="font-bold text-gray-800 text-sm">${srv.name}</span>
                    </div>
                    ${srv.price ? `<span class="font-bold text-green-700 bg-green-100 px-2 py-1 rounded-lg text-xs">$${srv.price}</span>` : ''}
                `;
                btn.onclick = () => seleccionarServicio(btn, srv, config);
                container.appendChild(btn);
            });

            const datePicker = document.getElementById('date-picker');
            const hoy = new Date().toLocaleDateString('en-CA');
            datePicker.value = hoy; datePicker.min = hoy;
            datePicker.addEventListener('change', () => cargarHorarios(config));
        }

        function seleccionarServicio(btn, servicio, config) {
            // Reset Visual
            document.querySelectorAll('#services-container > div').forEach(b => {
                b.className = "flex justify-between items-center p-3.5 rounded-xl border border-gray-200 bg-white text-gray-600 group";
                b.querySelector('.check-indicator').classList.add('opacity-0');
            });
            // Activar Seleccionado
            btn.className = "flex justify-between items-center p-3.5 rounded-xl border-2 border-primary bg-green-50 text-black shadow-md group";
            btn.querySelector('.check-indicator').classList.remove('opacity-0');
            
            servicioSeleccionado = servicio;
            localStorage.setItem('servicio_seleccionado', JSON.stringify(servicio));
            
            const cal = document.getElementById('calendar-section');
            cal.classList.remove('hidden'); setTimeout(()=>cal.classList.add('opacity-100'), 50);
            
            cargarHorarios(config);
            actualizarResumen("--:--");
        }

        async function cargarHorarios(config) {
            const fecha = document.getElementById('date-picker').value;
            const container = document.getElementById('slots-container');
            container.innerHTML = "<p class='col-span-3 text-center text-xs text-gray-400'>Cargando...</p>";

            const parts = fecha.split('-');
            const diaSemana = new Date(parts[0], parts[1]-1, parts[2]).getDay();
            
            if (!(config?.work_days || [1,2,3,4,5,6]).includes(diaSemana)) {
                container.innerHTML = `<div class="col-span-3 text-center p-3 bg-gray-50 rounded-xl text-gray-400 text-xs">Cerrado este día.</div>`;
                return;
            }

            const { data: reservas } = await supabase.from('bookings').select('booking_time').eq('business_email', negocioEmail).eq('booking_date', fecha);
            const ocupados = reservas ? reservas.map(r => r.booking_time.slice(0,5)) : [];

            container.innerHTML = "";
            let hayTurnos = false;
            (config?.shifts || [{start: "09:00", end: "18:00"}]).forEach(shift => {
                let current = new Date(`2000-01-01T${shift.start}`);
                const endTime = new Date(`2000-01-01T${shift.end}`);
                while (current < endTime) {
                    hayTurnos = true;
                    const h = current.getHours().toString().padStart(2, '0');
                    const m = current.getMinutes().toString().padStart(2, '0');
                    const timeStr = `${h}:${m}`;
                    const btn = document.createElement('button');
                    if (ocupados.includes(timeStr)) {
                        btn.className = "py-3 rounded-xl bg-gray-50 text-gray-300 font-bold text-xs line-through cursor-not-allowed";
                    } else {
                        btn.className = "time-btn py-3 rounded-xl border border-gray-200 font-bold text-gray-800 text-xs hover:border-primary active:bg-primary active:text-black transition-all bg-white";
                        btn.onclick = () => seleccionarHora(btn, timeStr, fecha);
                    }
                    btn.innerText = timeStr;
                    container.appendChild(btn);
                    current.setMinutes(current.getMinutes() + (config.slot_duration || 30));
                }
            });
            if (!hayTurnos) container.innerHTML = `<div class="col-span-3 text-center text-xs">No hay horarios.</div>`;
        }

        function seleccionarHora(btn, hora, fecha) {
            localStorage.setItem('turno_seleccionado', hora);
            localStorage.setItem('fecha_seleccionada', fecha);
            document.querySelectorAll('.time-btn').forEach(b => b.className = "time-btn py-3 rounded-xl border border-gray-200 font-bold text-gray-800 text-xs bg-white");
            btn.className = "time-btn py-3 rounded-xl border-2 border-primary bg-primary text-black font-bold shadow-md text-xs transform scale-105";
            
            actualizarResumen(hora);
            const btnCont = document.getElementById('btn-continuar');
            btnCont.disabled = false;
            btnCont.className = "bg-primary text-black px-6 py-3 rounded-full font-bold shadow-lg shadow-primary/20 transition-all transform active:scale-95 text-sm";
        }

        function actualizarResumen(hora) {
            const srv = servicioSeleccionado ? servicioSeleccionado.name : "...";
            document.getElementById('seleccion-texto').innerText = `${srv} - ${hora}`;
        }
    </script>
</body>
</html>